{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "description": "Deploys Azure Storage Account with Static Website hosting for SharePoint Download Monitoring Dashboard",
    "author": "Ofir Gavish & Eitan Talmi"
  },
  "parameters": {
    "storageAccountName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Azure Storage Account"
      },
      "minLength": 3,
      "maxLength": 24
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "storageAccountType": {
      "type": "string",
      "defaultValue": "Standard_LRS",
      "allowedValues": [
        "Standard_LRS",
        "Standard_GRS",
        "Standard_ZRS",
        "Premium_LRS"
      ],
      "metadata": {
        "description": "Storage Account type"
      }
    },
    "enableCdn": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable Azure CDN for better performance (adds cost - only enable for public/high-traffic scenarios)"
      }
    }
  },
  "variables": {
    "cdnProfileName": "[concat(parameters('storageAccountName'), '-cdn')]",
    "cdnEndpointName": "[concat(parameters('storageAccountName'), '-endpoint')]",
    "staticWebsiteIndexDocument": "index.html",
    "staticWebsiteErrorDocument": "error.html"
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2021-06-01",
      "name": "[parameters('storageAccountName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "[parameters('storageAccountType')]"
      },
      "kind": "StorageV2",
      "properties": {
        "supportsHttpsTrafficOnly": true,
        "allowBlobPublicAccess": true,
        "minimumTlsVersion": "TLS1_2",
        "allowSharedKeyAccess": true,
        "networkAcls": {
          "bypass": "AzureServices",
          "virtualNetworkRules": [],
          "ipRules": [],
          "defaultAction": "Allow"
        },
        "encryption": {
          "services": {
            "file": {
              "keyType": "Account",
              "enabled": true
            },
            "blob": {
              "keyType": "Account",
              "enabled": true
            }
          },
          "keySource": "Microsoft.Storage"
        },
        "staticWebsite": {
          "enabled": true,
          "indexDocument": "[variables('staticWebsiteIndexDocument')]",
          "errorDocument404Path": "[variables('staticWebsiteErrorDocument')]"
        }
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices",
      "apiVersion": "2021-06-01",
      "name": "[concat(parameters('storageAccountName'), '/default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
      ],
      "properties": {
        "deleteRetentionPolicy": {
          "enabled": false
        }
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2021-06-01",
      "name": "[concat(parameters('storageAccountName'), '/default/$web')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]"
      ],
      "properties": {
        "publicAccess": "Blob"
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2021-06-01",
      "name": "[concat(parameters('storageAccountName'), '/default/data')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]"
      ],
      "properties": {
        "publicAccess": "Blob"
      }
    },
    {
      "condition": "[parameters('enableCdn')]",
      "type": "Microsoft.Cdn/profiles",
      "apiVersion": "2020-04-15",
      "name": "[variables('cdnProfileName')]",
      "location": "Global",
      "sku": {
        "name": "Standard_Microsoft"
      },
      "properties": {}
    },
    {
      "condition": "[parameters('enableCdn')]",
      "type": "Microsoft.Cdn/profiles/endpoints",
      "apiVersion": "2020-04-15",
      "name": "[concat(variables('cdnProfileName'), '/', variables('cdnEndpointName'))]",
      "location": "Global",
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles', variables('cdnProfileName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
      ],
      "properties": {
        "originHostHeader": "[replace(replace(reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))).primaryEndpoints.web,'https://',''),'/','')]",
        "isHttpAllowed": false,
        "isHttpsAllowed": true,
        "queryStringCachingBehavior": "IgnoreQueryString",
        "origins": [
          {
            "name": "origin1",
            "properties": {
              "hostName": "[replace(replace(reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))).primaryEndpoints.web,'https://',''),'/','')]"
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2020-10-01",
      "name": "uploadDashboardFiles",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices/containers', parameters('storageAccountName'), 'default', '$web')]"
      ],
      "kind": "AzureCLI",

      "properties": {
        "azCliVersion": "2.50.0",
        "scriptContent": "echo 'Starting dashboard files upload and CORS configuration...' && WEBSITE_URL=\"https://$STORAGE_ACCOUNT_NAME.z6.web.core.windows.net\" && echo \"Website URL: $WEBSITE_URL\" && echo 'Configuring CORS using REST API...' && DATE=$(date -u +\"%a, %d %b %Y %H:%M:%S GMT\") && AUTH_HEADER=\"SharedKey $STORAGE_ACCOUNT_NAME:$(echo -n \"PUT\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\nx-ms-date:$DATE\\nx-ms-version:2021-06-01\\n/$STORAGE_ACCOUNT_NAME/?comp=properties&restype=service\" | openssl dgst -sha256 -hmac \"$(echo $STORAGE_KEY | base64 -d)\" -binary | base64)\" && curl -X PUT \"https://$STORAGE_ACCOUNT_NAME.blob.core.windows.net/?comp=properties&restype=service\" -H \"x-ms-date: $DATE\" -H \"x-ms-version: 2021-06-01\" -H \"Authorization: $AUTH_HEADER\" -H \"Content-Type: application/xml\" -d \"<?xml version='1.0' encoding='utf-8'?><StorageServiceProperties><Cors><CorsRule><AllowedOrigins>$WEBSITE_URL</AllowedOrigins><AllowedMethods>GET,HEAD,OPTIONS</AllowedMethods><AllowedHeaders>Origin,X-Requested-With,Content-Type,Accept,Authorization,x-ms-*</AllowedHeaders><ExposedHeaders>Content-Length,Content-Type,Date,Server,x-ms-*</ExposedHeaders><MaxAgeInSeconds>3600</MaxAgeInSeconds></CorsRule></Cors></StorageServiceProperties>\" && echo 'CORS configured successfully' && echo 'Downloading and uploading dashboard files...' && for file in 'index.html:text/html' 'dashboard.css:text/css' 'dashboard.js:application/javascript'; do filename=$(echo $file | cut -d: -f1) && contenttype=$(echo $file | cut -d: -f2) && echo \"Processing $filename\" && curl -s -o \"/tmp/$filename\" \"https://raw.githubusercontent.com/OfirGavish/SharePoint-Download-Report-Automation/main/dashboard/$filename\" && FILESIZE=$(stat -c%s \"/tmp/$filename\") && DATE=$(date -u +\"%a, %d %b %Y %H:%M:%S GMT\") && AUTH_HEADER=\"SharedKey $STORAGE_ACCOUNT_NAME:$(echo -n \"PUT\\n\\n\\n$FILESIZE\\n\\n$contenttype\\n\\n\\n\\n\\n\\n\\nx-ms-blob-type:BlockBlob\\nx-ms-date:$DATE\\nx-ms-version:2021-06-01\\n/$STORAGE_ACCOUNT_NAME/\\$web/$filename\" | openssl dgst -sha256 -hmac \"$(echo $STORAGE_KEY | base64 -d)\" -binary | base64)\" && curl -X PUT \"https://$STORAGE_ACCOUNT_NAME.blob.core.windows.net/\\$web/$filename\" -H \"x-ms-date: $DATE\" -H \"x-ms-version: 2021-06-01\" -H \"x-ms-blob-type: BlockBlob\" -H \"Content-Type: $contenttype\" -H \"Content-Length: $FILESIZE\" -H \"Authorization: $AUTH_HEADER\" --data-binary \"@/tmp/$filename\" && echo \"Uploaded $filename\"; done && echo 'Dashboard deployment completed successfully!'",
        "environmentVariables": [
          {
            "name": "STORAGE_ACCOUNT_NAME",
            "value": "[parameters('storageAccountName')]"
          },
          {
            "name": "STORAGE_KEY",
            "secureValue": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2021-06-01').keys[0].value]"
          }
        ],
        "retentionInterval": "P1D",
        "timeout": "PT10M"
      }
    }
  ],
  "outputs": {
    "storageAccountName": {
      "type": "string",
      "value": "[parameters('storageAccountName')]"
    },
    "primaryWebEndpoint": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))).primaryEndpoints.web]"
    },
    "cdnEndpoint": {
      "condition": "[parameters('enableCdn')]",
      "type": "string",
      "value": "[if(parameters('enableCdn'), concat('https://', variables('cdnEndpointName'), '.azureedge.net'), '')]"
    },
    "storageAccountKey": {
      "type": "string",
      "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').keys[0].value]"
    },
    "deploymentInstructions": {
      "type": "string",
      "value": "Your Azure Storage account has been created successfully! The dashboard files have been automatically uploaded to the $web container. Your static website is ready at the provided URL. Next steps: 1) Configure your PowerShell scripts with the provided storage account details, 2) Set up your Azure Automation runbook for scheduled data collection."
    },
    "dashboardUrl": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))).primaryEndpoints.web]"
    }
  }
}